{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            
            <div class="predict-card card shadow-lg border-0 animated-card">
                <div class="card-body p-4 p-md-5">
                    <h2 class="text-center fw-bold text-dark mb-3">Breast Cancer Classification</h2>
                    
                    {% if not prediction_text %}
                    <p class="text-center text-muted mb-4">
                        Upload histopathology images (.png, .jpg format) to be classified.
                    </p>
                    
                    <form id="predict-form" action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" class="upload-form">
                        <div class="drop-zone" id="drop-zone">
                            <div class="upload-icon-container">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                                    <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                </svg>
                                <h3 class="upload-title">Upload Histopathology Images</h3>
                                <p class="upload-text">Drag and drop files here or</p>
                                <label for="file" class="upload-button">
                                    Choose File
                                </label>
                                <p class="file-info text-muted mt-2">Supported formats: PNG, JPG</p>
                            </div>
                            <input class="file-input" type="file" name="file" id="file" accept=".png,.jpg,.jpeg" required>
                        </div>
                        
                        <div id="preview-container" class="preview-container hidden">
                            <div class="preview-header">
                                <span class="file-name">No files selected</span>
                                <button type="button" class="btn-remove" id="remove-file">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                            </div>
                            <img id="image-preview" src="#" alt="Preview Gambar" class="preview-image" style="display: none;">
                        </div>

                        <div class="predict-button-container">
                            <button type="submit" class="predict-button" id="predict-button" disabled>
                                <span class="button-text">Image Prediction</span>
                            </button>
                        </div>
                    </form>
                    
                    {% else %}
                    <div class="result-container">
                        <div class="result-box mb-4">
                            <div class="prediction-header">
                                <h3 id="prediction-data" data-pred="{{ prediction_text }}" class="result-title text-center mb-4">
                                    {{ prediction_text }}
                                </h3>
                            </div>
                            {% if image_path %}
                                <div class="image-container">
                                    <img src="{{ url_for('static', filename=image_path) }}" alt="Uploaded Image" class="uploaded-img mt-3">
                                </div>
                            {% endif %}
                        </div>

                        {% if explanation_text %}
                        <div class="explanation-box">
                            <div class="explanation-header">
                                <i class="bi bi-clipboard2-pulse-fill me-2"></i>
                                Hasil Analisis
                            </div>
                            <div class="explanation-content explanation-markdown">
                                {{ explanation_text | safe }}
                            </div>
                            
                            <div id="chat-wrapper" class="mt-4">
                                
                                <div class="chat-header ps-3"><b>Silahkan Ajukan Pertanyaan Terkait Hasil Prediksi Diatas</b></div>
                                
                                <form id="chat-form" class="mb-3">
                                    <div class="mb-2">
                                        <textarea name="message" class="form-control" 
                                                  placeholder="Apa saran terbaik yang harus saya lakukan?" 
                                                  rows="3" required></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </div>
                                </form>
                                
                                <div id="chat-container" class="chat-container mt-3">
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <a href="{{ url_for('predict') }}" class="btn btn-outline-secondary">
                                        Another classification
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


{% if prediction_text %}
<script>
    // Jalankan skrip hanya setelah halaman selesai dimuat
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. Ambil semua elemen yang kita butuhkan
        const chatForm = document.getElementById('chat-form');
        
        // Cek dulu apakah form-nya ada (untuk menghindari error)
        if (chatForm) {
            const chatContainer = document.getElementById('chat-container');
            const chatInput = chatForm.querySelector('textarea[name="message"]');
            const chatButton = chatForm.querySelector('button[type="submit"]');
            
            // Ambil data prediksi dari elemen h3 yang kita beri id tadi
            const predDataElement = document.getElementById('prediction-data');
            const predictionResult = predDataElement ? predDataElement.dataset.pred : "Tidak diketahui";

            // Fungsi helper untuk menambahkan pesan ke UI
            function appendMessage(sender, htmlContent) {
                const messageEl = document.createElement('div');
                messageEl.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
                
                if (sender === 'user') {
                    // Untuk user, kita tampilkan sebagai teks biasa untuk keamanan
                    messageEl.innerHTML = `<p><strong>Anda:</strong></p>`;
                    const p = document.createElement('p');
                    p.textContent = htmlContent;
                    messageEl.appendChild(p);
                } else {
                    // Untuk bot, kita masukkan sebagai HTML (karena sudah di-format oleh 'get_gemini_explanation')
                    messageEl.innerHTML = `<p><strong>Bot:</strong></p>${htmlContent}`;
                }
                
                chatContainer.appendChild(messageEl);
                chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll ke pesan baru
            }

            // 2. Tambahkan 'submit' event listener ke form
            // GANTI FUNGSI 'addEventListener' LAMA ANDA DENGAN INI

        chatForm.addEventListener('submit', function(event) {
            
            // 1. Mencegah refresh halaman
            event.preventDefault(); 
            
            const userMessage = chatInput.value.trim();
            if (userMessage === '') {
                return; // Jangan kirim pesan kosong
            }

            // 2. Tampilkan pesan pengguna
            appendMessage('user', userMessage);

            // 3. Kosongkan input
            chatInput.value = '';

            // --- PERBAIKAN LOADING DIMULAI ---
            // 4. Nonaktifkan tombol dan tampilkan spinner
            chatButton.disabled = true;
            chatButton.innerHTML = 'Processing...';
            // --- AKHIR PERBAIKAN ---

            // 5. Kirim data ke server (Flask)
            fetch('{{ url_for("chat") }}', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: userMessage,
                    prediction: predictionResult 
                })
            })
            .then(response => response.json())
            .then(data => {
                // 6. Tampilkan balasan dari Bot
                if (data.reply) {
                    appendMessage('bot', data.reply);
                } else {
                    appendMessage('bot', `<p class="text-danger">Error: ${data.error || 'Respons tidak valid'}</p>`);
                }
            })
            .catch(error => {
                // 7. Tampilkan jika ada error koneksi
                console.error('Fetch Error:', error);
                appendMessage('bot', `<p class="text-danger">Error: Tidak bisa terhubung ke server.</p>`);
            })
            .finally(() => {
                // --- PERBAIKAN LOADING SELESAI ---
                // 8. Apapun hasilnya, aktifkan kembali tombol dan kembalikan teksnya
                chatButton.disabled = false;
                chatButton.innerHTML = 'Kirim';
                // --- AKHIR PERBAIKAN ---
            });
        });
        }
    });
</script>
{% endif %}
{% endblock %}